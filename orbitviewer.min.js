'use strict';KMG.DefaultOrbitingObjectConfig={kmScalar:5E-6,rideAlong:!1,leaveTrail:!1,orbitsVisible:!0,dateMarkersVisible:!0,focusPoint:new THREE.Vector3(0,0,0),suppressFuture:!1,suppressDatesOfInterest:!1,useFadingVectorPath:!1,suppressSpacecraftModels:!1,elementsOrbitColor:16711680};
KMG.OrbitingObject=function(f,e,c,m,d,g,b){function k(a){return p.useVectorData&&(a<=v||!c.displayFuture&&a>=v)}function s(a){if(!k(a))return-1;if(a<A)return{f:0,lower:c.vectors.data[0],upper:c.vectors.data[0]};if(!c.displayFuture&&a>=v)return{f:0,lower:c.vectors.data[c.vectors.data.length-1],upper:c.vectors.data[c.vectors.data.length-1]};a=k(a)?(a-A)/(v-A):-1;a*=c.vectors.data.length;var b=parseInt(a),e=parseInt(Math.round(a+0.5));e>=c.vectors.data.length&&(e=b);return{f:a-Math.floor(a),lower:c.vectors.data[b],
upper:c.vectors.data[e]}}function q(a){k(a)?k(a)?(a=s(a),a=-1==a?-1:new THREE.Vector3(a.upper.x*a.f+a.lower.x*(1-a.f),a.upper.z*a.f+a.lower.z*(1-a.f),-(a.upper.y*a.f+a.lower.y*(1-a.f)))):a=-1:a=t.positionAtTime(a);return a}KMG.BaseObject.call(this);this.config=e=KMG.Util.extend(e,KMG.DefaultOrbitingObjectConfig);var p=this;this.centerOnSun=!1;var D=new THREE.Projector;this.lookingTowards=b?b:{position:new THREE.Vector3(0,0,0)};var n=[],r=KMG.AU_TO_KM*e.kmScalar;this.centerObjectVectors=d;this.centerObjectElements=
g;this.useVectorData=0<c.vectors.data.length;this.applyParentObliquity=!0;var t=new KMG.EllipticalOrbit(c.elements.data);this.getPlanetVector=function(){var a=this.getPosition();a.applyEuler(this.rotation);g&&a.add(g.getPlanetVector());return a};this.isAtScreenPosition=function(a,b,c,e,d){e||(e=0.033);var g=new THREE.Projector;a=new THREE.Vector3(a,b,1);b=this.getPosition();b.add(c.clone().negate());b.multiplyScalar(d);g.projectVector(b,f.camera);b.z=0;a.z=0;return a.distanceTo(b)<=e};this.onMousePosition=
function(a,b,c,f){if(e.suppressDatesOfInterest)return null;(a=this.isMouseOverDateOfInterest(a,b))?$("#event-container").html("<span class='event-date'>"+KMG.Util.formatJulianDay(a.date,!0,"ll")+"</span><br/><span class='event-title'>"+a.title+"</span>").css("top",""+f+"px").css("left",""+c+"px").css("display","inline-block"):$("#event-container").css("display","none")};this.isMouseOverDateOfInterest=function(a,b){if(e.suppressDatesOfInterest)return null;for(var d=new THREE.Vector3(a,b,1),g=e.focusPoint?
e.focusPoint:w.position.clone().negate(),h=0;h<c.datesOfInterest.length;h++){var k=c.datesOfInterest[h],l=k.position.clone().add(g);D.projectVector(l,f.camera);if(0.033>=d.distanceTo(l))return k}return null};this.update=function(){var a,b,d;l&&l.update();h&&(h.update(),h.setVisibility(this.config.orbitsVisible));x&&(x.update(),x.setVisibility(this.config.orbitsVisible));if(m.isActive()&&e.leaveTrail){var g=new KMG.DotPlotObject(f,{});g.position=l.position.clone();this.add(g)}for(var g=e.focusPoint?
e.focusPoint:w.position.clone().negate(),k=0;k<c.datesOfInterest.length&&!e.suppressDatesOfInterest;k++){var n=c.datesOfInterest[k];n.numberLabel.css("display",this.config.dateMarkersVisible?"inline-block":"none");n.marker.setVisibility(this.config.dateMarkersVisible);this.config.dateMarkersVisible&&(d=n.position.clone().add(g),a=n.numberLabel,D.projectVector(d,f.camera),a=(d.x+1)/2*window.innerWidth-a.width()/2,b=(-d.y+1)/2*window.innerHeight,a=parseInt(Math.round(a)),b=parseInt(Math.round(b)),d=
d.z,n.numberLabel.css("top",b+"px"),n.numberLabel.css("left",a+"px"),1<d?n.numberLabel.css("display","none"):n.numberLabel.css("display","inline-block"))}};this.getPosition=function(){return l.position.clone()};this.setUsingFadingLine=function(a){h.setUsingFadingLine(a)};this.setRideAlong=function(a){if(e.rideAlong){var b=new THREE.Matrix4;b.identity();var c=new THREE.Matrix4;c.makeTranslation(l.position.x,l.position.y,l.position.z);b.multiply(c);b.lookAt(l.position,a,new THREE.Vector3(0,1,0));c.makeTranslation(0,
5E3*e.kmScalar,5E4*e.kmScalar);f.camera.matrix.identity();f.camera.applyMatrix(b);f.camera.lookAt(a);f.camera.matrix.multiply(c);b=new THREE.Matrix4;b.lookAt(l.position,a,new THREE.Vector3(0,1,0));f.secondaryCamera.matrix.identity();new THREE.Matrix4;f.secondaryCamera.applyMatrix(b)}};this.getDistanceTo=function(a){return l.position.distanceTo(a)/r};this.getVelocityOnTick=function(){var a=m.tickJulian,b=0;k(a)?(k(a)?(a=s(a),-1==a?a=-1:(b=a.upper.vx*a.f+a.lower.vx*(1-a.f),a=new THREE.Vector3(b,a.upper.vy*
a.f+a.lower.vy*(1-a.f),b))):a=-1,a.multiplyScalar(1E3*KMG.AU_TO_KM),a.multiplyScalar(1/86400)):(a=t.velocityAtTime(a),a.multiplyScalar(1E3*KMG.AU_TO_KM));return b=Math.sqrt(KMG.Math.sqr(a.x)+KMG.Math.sqr(a.y)+KMG.Math.sqr(a.z))};var h;if(this.useVectorData){b={scale:r};var y=new KMG.VectorPathLine(f,b,d,c.vectors.data),z=new KMG.FadingVectorPathLine(f,b,d,c.vectors.data);h=new THREE.Object3D;h.add(y);h.add(z);h.update=function(){y.update();z.update()};h.setVisibility=function(a){y.setVisibility(a);
z.setVisibility(a)};h.setUsingFadingLine=function(a){a?(h.remove(y),h.add(z)):(h.add(y),h.remove(z))};h.setUsingFadingLine(e.useFadingVectorPath);this.add(h)}else this.useVectorData||c.displayFuture||(b={},b.scale=r,b.segments=16E3,b.opacity=0.8,b.color=16777215,b.closeOrbit=!1,b.lineThickness=1.5,b.orbit=t,h=new KMG.OrbitPathLine(f,b,t,g,c.start,c.stop),this.add(h));var l;if("spacecraft"==c.type){if(!e.suppressSpacecraftModels){b=c.model?c.model.file:"generic";var B=c.model?c.model.scale:1,u=function(a){a.scale.set(40,
40,40);a.traverse(function(a){a.scale.set(B,B,B);a.material&&(a.material.fog=!1,a.material.shading=THREE.SmoothShading)});p.add(a);n.push(a);a.update=function(){};l=a};if(KMG.Util.isUserMobile()){var C=new THREE.OBJLoader;C.load("obj/"+b+"/"+b+".obj",u)}else C=new THREE.OBJMTLLoader,C.load("obj/"+b+"/"+b+".obj","obj/"+b+"/"+b+".mtl",u)}}else"satellite"==c.type?(b={opacity:0.1,color:16711680,size:15,texture:"/img/sprites/satellite_100x100.png"},l=new KMG.DotPlotObject(f,b)):"comet"==c.type?l=new KMG.CometObject(f,
{lookingTowards:this.lookingTowards}):(e={radius:5E-4,fog:!1,scale:r,texture:"asteroid",color:16777215},l=new KMG.TexturedSphereObject(f,e)),this.add(l),n.push(l);b={opacity:0.1,color:16777215,texture:"/img/sprites/circle_50x50.png"};var w=new KMG.DotPlotObject(f,b);l||(l=w);this.add(w);n.push(w);var x;c.displayFuture&&!e.suppressFuture&&(b={},b.scale=r,b.segments=8192,b.opacity=0.8,b.color=e.elementsOrbitColor,b.lineThickness=1.5,x=new KMG.OrbitPathLine(f,b,t,g,c.start,c.stop),this.add(x));b=new KMG.BillBoardTextObject(f,
c.name,{});this.add(b);n.push(b);b=new KMG.EllipticalOrbiter(f,n,r,0,t,g,m);this.useVectorData&&(b=new KMG.EphemerisOrbiter(f,n,r,0,b,c.vectors,c.displayFuture,d,g,m));var A,v;this.useVectorData&&(A=c.vectors.data[0].epoch,v=c.vectors.data[c.vectors.data.length-1].epoch);if(!e.suppressDatesOfInterest)for(d=0;d<c.datesOfInterest.length;d++)b=new KMG.DotPlotObject(f,{opacity:1,size:32,texture:"/img/sprites/bullet_red.png"}),u=q(c.datesOfInterest[d].date),u.multiplyScalar(r),b.position=u,this.add(b),
c.datesOfInterest[d].marker=b,c.datesOfInterest[d].position=u,console.info("Creating date of interest for "+(d+1)),b=$("<div/>").attr("id","number-label-"+d).addClass("scene-object-label").text(""+(d+1)).appendTo("body"),c.datesOfInterest[d].numberLabel=b};KMG.OrbitingObject.prototype=Object.create(KMG.BaseObject.prototype);
KMG.DefaultOrbitingPlanetConfig={kmScalar:5E-6,radius:6E3,speed:1,showRing:!1,texture:"",orbiting:null,name:"",type:"major",dotSize:2,planetEmissive:0,focusPoint:new THREE.Vector3(0,0,0)};
KMG.OrbitingPlanet=function(f,e,c,m,d){KMG.BaseObject.call(this);this.config=e=KMG.Util.extend(e,KMG.DefaultOrbitingPlanetConfig);this.context=f;this.orbit=c;this.iauRotation=d;this.tickController=m;d=KMG.AU_TO_KM*this.config.kmScalar;var g={};g.scale=d;g.segments=128;g.opacity="major"==this.config.type?0.6:0.3;g.color=3166207;g.lineThickness=1.5;var b=new KMG.OrbitPathLine(f,g,c,this.config.orbiting);this.add(b);var k=new KMG.TexturedSphereObject(f,{radius:e.radius,fog:!1,scale:e.kmScalar,texture:e.texture,
color:16777215,emissive:e.planetEmissive});this.planet=k;this.add(k);var s=new KMG.DotPlotObject(f,{opacity:1,color:16777215,size:e.dotSize,texture:"img/sprites/circle_50x50.png"});this.add(s);var g=[s,k],q;q=$("<div/>").attr("id","name-label-"+this.config.name).addClass("scene-object-label").text(this.config.name).css("display","major"==this.config.type?"inline-block":"none").appendTo("body");var p;this.config.showRing&&(p=new KMG.RingObject(f,{ringInnerRadius:74500*this.config.kmScalar,ringOutterRadius:140220*
this.config.kmScalar,targetObject:k,displayRing:!0}),this.add(p),g.push(p));this.orbiter=c=new KMG.EllipticalOrbiter(f,g,d,this.config.speed,c,this.config.orbiting,m);this.planet.orbiter=c;this.update=function(){k&&k.update();p&&p.update();s&&s.update();b&&b.update();var c=new THREE.Projector,d=k.position.clone().add(e.focusPoint);c.projectVector(d,f.camera);c=(d.x+1)/2*window.innerWidth-q.width()/2;q.css("top",parseInt((-d.y+1)/2*window.innerHeight)+"px");q.css("left",parseInt(c)+"px");1<d.z?q.css("display",
"none"):q.css("display","inline-block");this.iauRotation&&(d=this.iauRotation.computeRotationalQuaternion(this.tickController.tickJulian),k.sphereMesh.rotation.setFromQuaternion(d),k.updateMatrix(),p&&(p.rotation.setFromQuaternion(d),p.updateMatrix()))};this.onMousePosition=function(b,c){if(q&&"minor"==this.config.type){var d=new THREE.Projector,g=new THREE.Vector3(b,c,1),h=k.position.clone().add(e.focusPoint);d.projectVector(h,f.camera);0.033>=g.distanceTo(h)?q.css("display","inline-block"):q.css("display",
"none")}}};KMG.OrbitingPlanet.prototype=Object.create(KMG.BaseObject.prototype);KMG.DefaultCentralSunConfig={texture:KMG.starFlares[0].name,kmScalar:5E-6};
KMG.CentralSunObject=function(f,e){KMG.BaseObject.call(this);this.config=e=KMG.Util.extend(e,KMG.DefaultCentralSunConfig);this.context=f;var c=new KMG.TexturedSphereObject(f,{radius:696342*e.kmScalar,fog:!1,scale:e.kmScalar,texture:"Sun",ambient:16777215,emissive:16777215,shading:!1,color:16777215});this.add(c);var m=KMG.TextureMap.getFlareDefinitionByName(e.texture),d=null!=m.texture?KMG.TextureMap.loadTexture(m.texture):null;d.wrapS=d.wrapT=THREE.ClampToEdgeWrapping;d.format=THREE.RGBAFormat;d.needsUpdate=
!0;m=new THREE.Object3D;d=new THREE.SpriteMaterial({fog:!1,color:16777215,sizeAttenuation:!1,transparent:!0,blending:THREE.AdditiveBlending,useScreenCoordinates:!1,depthWrite:!1,depthTest:!0,map:d});d=new THREE.Sprite(d);d.scale.set(100,100,1);m.add(d);m.update=function(){};m.position=new THREE.Vector3(0,0,0);this.add(m);this.isAtScreenPosition=function(c,b,d,e){e||(e=0.033);var m=new THREE.Projector;c=new THREE.Vector3(c,b,1);b=this.position.clone();b.add(d.clone().negate());m.projectVector(b,f.camera);
return c.distanceTo(b)<=e};this.update=function(){c&&c.update()}};KMG.CentralSunObject.prototype=Object.create(KMG.BaseObject.prototype);
